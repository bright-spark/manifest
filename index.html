<!DOCTYPE html>
<html>
<head>
<title>Manifest generator</title>
<script src="es6-promise.min.js"></script>
<style>
#dl { display: none; }
pre {
    overflow-y: auto;
    background: #ccc;
    height: 5em;
    padding: 0.5em;
}
</style>
</head>
<body>
<form>
    <p><label>enter url <input name="url" type="url" value="http://www.opera.com"></label></p>
    <p>orientation: 
        <label><input type="radio" name="orientation" value="portrait" checked> portrait</label>
        <label><input type="radio" name="orientation" value="landscape"> landscape</label>
    </p>
    <p><label>fullscreen (https only)? <input type="checkbox" name="fullscreen" disabled></label></p>
    <input type="submit">
</form>
<p><a href="#" id="dl" download="offline.manifest">Download <em>offline.manifest</em></a></p>
<pre>...</pre>
<script>
var m = {
  "lang": "en",
  "name": "Super Racer 2000",
  "short_name": "Racer2K",
  "icons": [{
        "src": "icon/lowres",
        "sizes": "64x64",
        "type": "image/webp"
      }, {
        "src": "icon/hd_small",
        "sizes": "64x64"
      }, {
        "src": "icon/hd_hi",
        "sizes": "128x128",
        "density": 2
      }],
  "splash_screens": [{
        "src": "splash/lowres",
        "sizes": "320x240"
      }, {
        "src": "splash/hd_small",
        "sizes": "1334x750"
      }, {
        "src": "splash/hd_hi",
        "sizes": "1920x1080",
        "density": 3
      }],
  "scope": "/racer/",
  "start_url": "/racer/start.html",
  "display": "fullscreen",
  "orientation": "landscape",
  "theme_color": "aliceblue",
  "background_color": "red"
};

(function() {
    var manifest;
    if (!window.URL && window.webkitURL) window.URL = window.webkitURL;

    function getImageMimeType(imgurl, userdata) {
        return new Promise(function(resolve, reject) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://crossorigin.me/" + imgurl, true);
            xhr.onload = function() {
                clearTimeout(tAbort);
                if (xhr.status == 200) {
                    resolve({url: imgurl, userdata: userdata, mimetype: xhr.getResponseHeader("Content-Type")});
                } else {
                    reject(Error("Mime-type request failed with status " + xhr.status + " and message " + xhr.statusText));
                }
            };
            xhr.onerror = function() {
                reject(Error("Network error"));
            };
            var tAbort = setTimeout(function() {
                xhr.abort();
                reject(Error("Mime-type request timed out"));
            }, 1000);
            xhr.send();
        });
    }

    function reflect(promise){
        return promise.then(function(v){ return {v:v, status: "resolved" }; },
                            function(e){ return {e:e, status: "rejected" }; });
    }

    function setDownloadUrl() {
        var a = document.getElementById('dl');
        if (a) {
            window.URL.revokeObjectURL(a.href);
        }
        var bb = new Blob([JSON.stringify(manifest, null, 2)], {type: "text/plain"});
        a.href = window.URL.createObjectURL(bb);
    }

    function display() {
        document.querySelector("pre").firstChild.nodeValue = JSON.stringify(manifest, null, 2);
        document.getElementById("dl").style.display = "inline";
    }

    function updateUserSelections() {
        manifest.orientation = document.querySelector("[name=orientation]:checked").value;
        delete manifest.fullscreen;
        if (document.getElementsByName("fullscreen")[0].checked) {
            manifest.display = "fullscreen";
        }
    }

    function parse(html) {
        var d = document.createElement("div");
        d.innerHTML = html;
        manifest = {};
        var mimeTypeFetches = [];

        // Basic data
        var title = d.querySelector("title");
        if (title) { manifest.name = title.textContent; }

        // Language: can't pull this out of d because the html element doesn't get inserted, so, regexps it is. Sorry, Tony the Pony
        var langmatch = html.match(/<html [^>]*\blang="([^"]+)"[^>]*>/i);
        if (langmatch) { manifest.lang = langmatch[1]; }

        // User selections
        updateUserSelections();

        // Apple touch icons
        [].slice.call(d.querySelectorAll('link[rel="apple-touch-icon"][href]')).forEach(function(l) {
            mimeTypeFetches.push(getImageMimeType(l.getAttribute("href"), {sizes: l.getAttribute("sizes")}));
        });

        Promise.all(mimeTypeFetches.map(reflect)).then(function(results) { // we know they all pass because they're reflected
            manifest.icons = results.filter(function(r) {
                return r.status == "resolved";
            }).map(function(r) {
                return {
                    src: r.v.url,
                    type: r.v.mimetype,
                    sizes: r.v.userdata.sizes
                };
            });
            display();
        });
    }

    function get(url) {
        console.log("fetching...");
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "http://crossorigin.me/" + url, true);
        xhr.onload = function() {
            if (xhr.status == 200) {
                parse(xhr.responseText);
            } else {
                alert("didn't work. Soz.");
            }
        };
        xhr.send();
    }

    [].slice.call(document.querySelectorAll("input[type=radio]")).forEach(function(widget) {
        widget.addEventListener("change", function(e) {
            if (manifest) {
                updateUserSelections();
                display();
            }
        }, false);
    });
    var textUrl = document.querySelector("[name=url]"),
        cbFullscreen = document.querySelector("[name=fullscreen]");
    textUrl.addEventListener("keyup", function(e) {
        if (textUrl.value.match(/^https:/)) {
            cbFullscreen.disabled = false;
        } else {
            cbFullscreen.checked = false;
            cbFullscreen.disabled = true;
        }
    });

    document.getElementById("dl").addEventListener("click", setDownloadUrl, false);

    document.querySelector("form").addEventListener("submit", function(e) {
        e.preventDefault();
        get(document.querySelector("input[type=url]").value);
    }, false);
})();
</script>
</body>
</html>